<style nonce="<%= style_nonce %>">
  .af-wrap { max-width: 720px; margin: 24px auto; padding: 0 12px; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
  .af-card { border: 1px solid #ddd; border-radius: 10px; padding: 16px; }
  .af-row { margin-bottom: 12px; }
  .af-row label { display:block; font-weight: 600; margin-bottom: 6px; }
  .af-input, .af-textarea { width: 100%; box-sizing: border-box; padding: 10px; border: 1px solid #bbb; border-radius: 8px; }
  .af-textarea { min-height: 160px; }
  .af-actions { display:flex; gap: 10px; align-items:center; flex-wrap: wrap; }
  .af-btn { padding: 10px 14px; border: 0; border-radius: 8px; cursor: pointer; }
  .af-btn-primary { background: #1677ff; color: #fff; }
  .af-btn-muted { background: #eee; }
  .af-status { margin-top: 12px; font-weight: 600; }
  .af-hidden { display:none; }

  /* Mobile Verbesserungen */
  @media (max-width: 480px) {
    .af-wrap { margin: 16px auto; padding: 0 10px; }
    .af-card { padding: 12px; border-radius: 12px; }
    .af-actions { gap: 8px; }
    .af-btn { width: 100%; padding: 12px 14px; }
    .af-textarea { min-height: 120px; }
  }
</style>

<div class="af-wrap">
  <h1>Anonymes Feedback</h1>
  <p>Kein Login nötig. Erst Türcode eingeben, danach Nachricht verfassen.</p>

  <div class="af-card">

    <!-- Screen 1: Türcode -->
    <div id="af-step-code" class="<%= session[:anon_feedback_unlocked] ? "af-hidden" : "" %>">
      <div class="af-row">
        <label for="af_door_code">Türcode</label>
        <input id="af_door_code" class="af-input" type="password" autocomplete="off" inputmode="numeric" />
      </div>

      <!-- Honeypot -->
      <input type="text" id="af_website1" style="display:none" tabindex="-1" autocomplete="off">

      <div class="af-actions">
        <button id="af_unlock_btn" class="af-btn af-btn-primary" type="button">Weiter</button>
      </div>
      <div id="af_code_status" class="af-status"></div>
    </div>

    <!-- Screen 2: Formular -->
    <div id="af-step-form" class="<%= session[:anon_feedback_unlocked] ? "" : "af-hidden" %>">
      <form id="af-form">
        <div class="af-row">
          <label for="af_subject">Betreff</label>
          <input id="af_subject" name="subject" class="af-input" type="text" maxlength="120" required />
        </div>

        <div class="af-row">
          <label for="af_message">Nachricht</label>
          <textarea id="af_message" name="message" class="af-textarea" required></textarea>
        </div>

        <!-- Honeypot -->
        <input type="text" name="website" id="af_website2" style="display:none" tabindex="-1" autocomplete="off">

        <div class="af-actions">
          <button class="af-btn af-btn-primary" type="submit">Senden</button>
          <button id="af_back_btn" class="af-btn af-btn-muted" type="button">Zurück</button>
        </div>

        <div id="af_form_status" class="af-status"></div>
      </form>
    </div>

  </div>
</div>

<script nonce="<%= script_nonce %>">
(function () {
  const stepCode = document.getElementById("af-step-code");
  const stepForm = document.getElementById("af-step-form");

  const codeInput = document.getElementById("af_door_code");
  const unlockBtn = document.getElementById("af_unlock_btn");
  const codeStatus = document.getElementById("af_code_status");
  const hp1 = document.getElementById("af_website1");

  const form = document.getElementById("af-form");
  const backBtn = document.getElementById("af_back_btn");
  const formStatus = document.getElementById("af_form_status");
  const hp2 = document.getElementById("af_website2");

  function setStatus(el, msg, isError) {
    el.textContent = msg || "";
    el.style.color = isError ? "#c62828" : "#2e7d32";
  }

  async function postJSON(url, payload) {
    const res = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });
    const data = await res.json().catch(() => ({}));
    return { res, data };
  }

  unlockBtn?.addEventListener("click", async () => {
    setStatus(codeStatus, "Prüfe…", false);

    const door_code = codeInput.value || "";
    const website = hp1.value || "";

    const { res, data } = await postJSON("/anonymous-feedback/unlock", { door_code, website });

    if (!res.ok) {
      codeInput.value = "";
      codeInput.focus();
      setStatus(codeStatus, data.error || "Türcode falsch.", true);
      return;
    }

    setStatus(codeStatus, "", false);
    stepCode.classList.add("af-hidden");
    stepForm.classList.remove("af-hidden");
    document.getElementById("af_subject")?.focus();
  });

  backBtn?.addEventListener("click", () => {
    // optional: Back nur UI (Session bleibt unlocked bis Send oder Reload)
    stepForm.classList.add("af-hidden");
    stepCode.classList.remove("af-hidden");
    setStatus(formStatus, "", false);
    setStatus(codeStatus, "", false);
    codeInput.focus();
  });

  form?.addEventListener("submit", async (e) => {
    e.preventDefault();
    setStatus(formStatus, "Sende…", false);

    const subject = document.getElementById("af_subject").value || "";
    const message = document.getElementById("af_message").value || "";
    const website = hp2.value || "";

    const { res, data } = await postJSON("/anonymous-feedback", { subject, message, website });

    if (!res.ok) {
      setStatus(formStatus, data.error || "Fehler beim Senden.", true);
      return;
    }

    setStatus(formStatus, "Danke! Feedback wurde angenommen.", false);
    form.reset();

    // Nach Erfolg wieder auf Code-Screen (weil Controller die Session löscht)
    stepForm.classList.add("af-hidden");
    stepCode.classList.remove("af-hidden");
    codeInput.value = "";
    codeInput.focus();
  });
})();
</script>
